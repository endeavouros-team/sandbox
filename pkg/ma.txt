#!/bin/bash

BashrcConfig() {
  cat <<EOF >> $home/.bashrc

alias l='ls -la --ignore=.?*'
alias ll='ls -la --ignore=..'

alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -i'
alias ln='ln -i'

alias nano='nano -l'
alias pacdiff=eos-pacdiff

alias poweroff='sync; poweroff'
alias reboot='sync; reboot'
alias update-grub='grub-mkconfig -o /boot/grub/grub.cfg'
alias df='df -hT'
alias md='code-oss -n'             # Visual Studio Code as a markdown editor
alias sou='source ~/.bashrc'       # re-read ~/.bashrc

bind '"\e[A":history-search-backward'      # history with arrow up key
bind '"\e[B":history-search-forward'       # history with arrow down key
bind 'set show-all-if-ambiguous on'        # complete with single TAB
bind 'set mark-symlinked-directories on'   # complete directory symlinks with slash

export LESS="-RF"

PS1='\w> '

EOF
  chown $new_user:$new_user $home/.bashrc    # not really needed if it already exists
}

EmacsConfig() {
  cat <<EOF > $home/.emacs
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(c-guess-guessed-basic-offset 2 t)
 '(column-number-mode t)
 '(cua-mode t nil (cua-base))
 '(gdb-many-windows t)
 '(global-display-line-numbers-mode t)
 '(indent-tabs-mode nil)
 '(inhibit-startup-screen t)
 '(make-backup-files nil)
 '(next-line-add-newlines nil)
 '(package-selected-packages '(realgud))
 '(require-final-newline t)
 '(scroll-step 1)
 '(select-enable-clipboard t)
 '(tool-bar-mode nil)
 '(tool-bar-position 'right)
 '(vc-follow-symlinks t)
 '(x-select-enable-clipboard-manager nil))
EOF
  chown $new_user:$new_user $home/.emacs
}

Main() {
  Install=(
    #linux-lts linux-lts-headers
    akm
    atril
    code
    emacs
    gparted
    gufw
    #kaffeine
    #libreoffice-fresh
    llpp
    #meld
    mpv
    ncdu
    rcs
    simple-scan
    solaar
    terminator
  )

  Remove=(
    #r8168
    adobe-source-han-sans-jp-fonts
    adobe-source-han-sans-kr-fonts
    adobe-source-han-sans-cn-fonts
    glances
    s-tui
    keyserver-rank
    parole
    #mousepad
    xed
    #blueberry
    capitaine-cursors
    file-roller
  )
  local need_mkinitcpio=no

  if [ "${Install[0]}" = "linux-lts" ] && (! pacman -Q linux-lts >& /dev/null) ; then
    need_mkinitcpio=yes
  fi

  local new_user=""
  if [ -r /tmp/new_username.txt ] ; then
    new_user=$(cat /tmp/new_username.txt)
  fi
  local home=/home/$new_user
  if [ -n "$new_user" ] && [ -d $home ] ; then
    # Add here some user specific stuff!
    EmacsConfig
    BashrcConfig
  fi  

  pacman -Rsn --noconfirm "${Remove[@]}"
  pacman -Syu --noconfirm --needed "${Install[@]}"
  sleep 1

  if [ "$need_mkinitcpio" = "yes" ] ; then
    mkinitcpio -p linux-lts
    sleep 1
    grub-mkconfig -o /boot/grub/grub.cfg
  fi
  systemctl enable ufw
}

Main
