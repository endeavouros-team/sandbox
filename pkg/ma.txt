#!/bin/bash

BashrcConfig() {
    [ -n "$new_user" ] || return

    cat <<EOF >> $home/.bashrc

alias l='ls -la --ignore=.?*'
alias ll='ls -la --ignore=..'

alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -i'
alias ln='ln -i'

alias nano='nano -l'
alias pacdiff=eos-pacdiff

alias poweroff='sync; poweroff'
alias reboot='sync; reboot'
alias update-grub='grub-mkconfig -o /boot/grub/grub.cfg'
alias df='df -hT'
alias md='code-oss -n'             # Visual Studio Code as a markdown editor
alias grep='grep -n'
alias sou='source ~/.bashrc'       # re-read ~/.bashrc

bind '"\e[A":history-search-backward'      # history with arrow up key
bind '"\e[B":history-search-forward'       # history with arrow down key
bind 'set show-all-if-ambiguous on'        # complete with single TAB
bind 'set mark-symlinked-directories on'   # complete directory symlinks with slash

export LESS="-RFn"

PS1='\w> '

EOF
    chown $new_user:$new_user $home/.bashrc    # not really needed if it already exists
}

EmacsConfig() {
    [ -n "$new_user" ] || return
    [ -x /usr/bin/emacs ] || return

    cat <<EOF > $home/.emacs
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(c-guess-guessed-basic-offset 2 t)
 '(column-number-mode t)
 '(cua-mode t nil (cua-base))
 '(gdb-many-windows t)
 '(global-display-line-numbers-mode t)
 '(indent-tabs-mode nil)
 '(inhibit-startup-screen t)
 '(make-backup-files nil)
 '(next-line-add-newlines nil)
 '(package-selected-packages '(realgud))
 '(require-final-newline t)
 '(scroll-step 1)
 '(select-enable-clipboard t)
 '(tool-bar-mode nil)
 '(tool-bar-position 'right)
 '(vc-follow-symlinks t)
 '(x-select-enable-clipboard-manager nil))
EOF
    chown $new_user:$new_user $home/.emacs
}

GetNewUserName() {
    if [ -r /tmp/new_username.txt ] ; then
        new_user=$(cat /tmp/new_username.txt)
    fi
}

HomeSettings() {
    # Add here some user specific stuff!
    if [ -n "$new_user" ] && [ -d $home ] ; then
        EmacsConfig
        BashrcConfig
    fi  
}

Main() {
    local new_user=""
    GetNewUserName
    local home="/home/$new_user"

    Install=(   # packages to install
        akm
        atril
        code
        emacs
        gparted
        gufw
        #kaffeine
        #libreoffice-fresh
        llpp            # fast PDF reader for complex PDF files
        mpv
        ncdu
        #rcs
        simple-scan
        solaar
        terminator
    )

    Remove=(    # packages to remove
        adobe-source-han-sans-jp-fonts
        adobe-source-han-sans-kr-fonts
        adobe-source-han-sans-cn-fonts
        glances
        s-tui
        parole
        #mousepad
        #xed
        #blueberry
        capitaine-cursors
        file-roller
    )

    pacman -Rsn --noconfirm "${Remove[@]}"
    pacman -Syu --noconfirm --needed "${Install[@]}"

    # enable firewall service
    sleep 1
    systemctl enable ufw

    # modify some dotfiles at $HOME
    HomeSettings
}

Main
